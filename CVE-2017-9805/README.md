# CVE-2017-9805 S2-052 CodeQL 查询

## 构建数据库

### 下载源码

下载这个[分支](https://github.com/apache/struts-examples/tree/8651c35385a9a228ff7dbe80bbc681d0e4de5e4e)（*8651c35*）下的 struts-examples，版本是 2.5.12。

### 编译环境

- Windows 10
- Apache Maven 3.5.3
- Java 1.8.0_102
- CodeQL  2.13.5

### 编译源码

我们只需要编译受漏洞影响的 `rest-angular` 即可。先直接编译以下看看是否有编译的问题，成功编译之后即可使用 CodeQL 建库了。

```bash
mvn clean package -pl :rest-angular -am -DskipTests
```

> 这里的 `-pl` 选项用于指定要构建的模块，`:rest-angular` 是使用 Struts 2 REST Plugin 的实例模块的名称。而 `-am` 选项会构建当前模块及其依赖模块。

### CodeQL 建库

```bash
codeql database create CVE-2017-9805-codeqlDB --language=java --command='mvn clean package -pl :rest-angular -am -DskipTests'
```

## CodeQL 查询

```codeql
/** 
* @kind path-problem 
*/
import java
import semmle.code.java.dataflow.TaintTracking
import DataFlow::PathGraph

/**  查找XML反序列化的地方，确定 sink 类似 x.fromXML(a,...) 的 a 的位置，使用需要传入一个 Expr，作为 fromXML 方法的第一个参数 */
predicate isXMLDeserialized(Expr arg) {
  exists(MethodAccess fromXML |
    fromXML.getMethod().getName() = "fromXML" and
    (arg = fromXML.getArgument(0))
  )
}

/** ContentTypeHandler 接口 */
/** The interface `org.apache.struts2.rest.handler.ContentTypeHandler`. */
class ContentTypeHandler extends RefType {
    ContentTypeHandler() {
      this.hasQualifiedName("org.apache.struts2.rest.handler", "ContentTypeHandler")
    }
}

/** 找到 toObject 方法，并且这个方法所在的类是 ContentTypeHandler 接口的实现*/
/** A `toObject` method on a subtype of `org.apache.struts2.rest.handler.ContentTypeHandler`. */
class ContentTypeHandlerToObject extends Method {
    ContentTypeHandlerToObject() {
      this.getDeclaringType().getASupertype() instanceof ContentTypeHandler and
      this.hasName("toObject")
    }
}

/** 污点跟踪配置类 */
/** x.toObject(a,...) -> ... -> y.fromXML(a,...) */
class StrutsUnsafeDeserializationConfig extends TaintTracking::Configuration {
    StrutsUnsafeDeserializationConfig() { this = "StrutsUnsafeDeserializationConfig" }

    /** toObject 方法 的第一个参数作为 source */
    override predicate isSource(DataFlow::Node source) {
        exists(ContentTypeHandlerToObject toObjectMethod  |
            source.asParameter() = toObjectMethod.getParameter(0)
        )
    }
    /** fromXML 方法的第一个参数作为 sink */
    override predicate isSink(DataFlow::Node sink) {
        exists(Expr arg |
            isXMLDeserialized(arg) and
            sink.asExpr() = arg
        )
    }
}

/** 固定查询 FlowPath 的查询格式 */
from StrutsUnsafeDeserializationConfig cfg, DataFlow::PathNode source, DataFlow::PathNode sink
where cfg.hasFlowPath(source, sink)
select sink, source, sink, "Custom constraint error message contains unsanitized user data"
```

## 漏洞复现

上面建库完成后，将 `\struts-examples\rest-angular\target\rest-angular-1.0.0.war` 复制到 Tocmat 的 webapps，参考 [vulhub/struts2/s2-052](https://github.com/vulhub/vulhub/tree/c8121bc2ee1e5bc8607a7e04681f77cce9105b58/struts2/s2-052#s2-052-remote-code-execution-vulnerablity) 即可复现漏洞。

## 源码调试

修改 catalina.bat文件已启用调试，直接正常启动 Tomcat 即可。

```
// 修改前
set "JAVA_OPTS=%JAVA_OPTS% -Djava.protocol.handler.pkgs=org.apache.catalina.webresources"

// 修改后
set "JAVA_OPTS=%JAVA_OPTS% -Djava.protocol.handler.pkgs=org.apache.catalina.webresources -agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=5005"
```

使用 IDEA 项目打开 struts-examples 文件夹，配置 Remote Debug 即可连接调试。

### 调用链

```
start:1007, ProcessBuilder (java.lang)
invoke0:-1, NativeMethodAccessorImpl (sun.reflect)
invoke:62, NativeMethodAccessorImpl (sun.reflect)
invoke:43, DelegatingMethodAccessorImpl (sun.reflect)
invoke:498, Method (java.lang.reflect)
filter:613, ImageIO$ContainsFilter (javax.imageio)
advance:821, FilterIterator (javax.imageio.spi)
next:839, FilterIterator (javax.imageio.spi)
chooseFirstProvider:746, Cipher (javax.crypto)
update:1828, Cipher (javax.crypto)
getMoreData:132, CipherInputStream (javax.crypto)
read:239, CipherInputStream (javax.crypto)
readFrom:65, ByteArrayOutputStreamEx (com.sun.xml.internal.bind.v2.util)
get:182, Base64Data (com.sun.xml.internal.bind.v2.runtime.unmarshaller)
toString:286, Base64Data (com.sun.xml.internal.bind.v2.runtime.unmarshaller)
getStringValue:122, NativeString (jdk.nashorn.internal.objects)
hashCode:118, NativeString (jdk.nashorn.internal.objects)
hash:338, HashMap (java.util)
put:611, HashMap (java.util)
putCurrentEntryIntoMap:113, MapConverter (com.thoughtworks.xstream.converters.collections)
populateMap:98, MapConverter (com.thoughtworks.xstream.converters.collections)
populateMap:92, MapConverter (com.thoughtworks.xstream.converters.collections)
unmarshal:87, MapConverter (com.thoughtworks.xstream.converters.collections)
convert:72, TreeUnmarshaller (com.thoughtworks.xstream.core)
convert:65, AbstractReferenceUnmarshaller (com.thoughtworks.xstream.core)
convertAnother:66, TreeUnmarshaller (com.thoughtworks.xstream.core)
convertAnother:50, TreeUnmarshaller (com.thoughtworks.xstream.core)
start:134, TreeUnmarshaller (com.thoughtworks.xstream.core)
unmarshal:32, AbstractTreeMarshallingStrategy (com.thoughtworks.xstream.core)
unmarshal:1206, XStream (com.thoughtworks.xstream)
unmarshal:1190, XStream (com.thoughtworks.xstream)
fromXML:1120, XStream (com.thoughtworks.xstream)
toObject:45, XStreamHandler (org.apache.struts2.rest.handler)
intercept:60, ContentTypeInterceptor (org.apache.struts2.rest)
invoke:247, DefaultActionInvocation (com.opensymphony.xwork2)
invoke:135, RestActionInvocation (org.apache.struts2.rest)
doIntercept:134, ParametersInterceptor (com.opensymphony.xwork2.interceptor)
intercept:98, MethodFilterInterceptor (com.opensymphony.xwork2.interceptor)
invoke:247, DefaultActionInvocation (com.opensymphony.xwork2)
invoke:135, RestActionInvocation (org.apache.struts2.rest)
intercept:199, StaticParametersInterceptor (com.opensymphony.xwork2.interceptor)
invoke:247, DefaultActionInvocation (com.opensymphony.xwork2)
invoke:135, RestActionInvocation (org.apache.struts2.rest)
intercept:88, CheckboxInterceptor (org.apache.struts2.interceptor)
invoke:247, DefaultActionInvocation (com.opensymphony.xwork2)
invoke:135, RestActionInvocation (org.apache.struts2.rest)
intercept:246, FileUploadInterceptor (org.apache.struts2.interceptor)
invoke:247, DefaultActionInvocation (com.opensymphony.xwork2)
invoke:135, RestActionInvocation (org.apache.struts2.rest)
intercept:99, ModelDrivenInterceptor (com.opensymphony.xwork2.interceptor)
invoke:247, DefaultActionInvocation (com.opensymphony.xwork2)
invoke:135, RestActionInvocation (org.apache.struts2.rest)
intercept:139, ScopedModelDrivenInterceptor (com.opensymphony.xwork2.interceptor)
invoke:247, DefaultActionInvocation (com.opensymphony.xwork2)
invoke:135, RestActionInvocation (org.apache.struts2.rest)
doIntercept:134, ParametersInterceptor (com.opensymphony.xwork2.interceptor)
intercept:98, MethodFilterInterceptor (com.opensymphony.xwork2.interceptor)
invoke:247, DefaultActionInvocation (com.opensymphony.xwork2)
invoke:135, RestActionInvocation (org.apache.struts2.rest)
intercept:105, ProfilingActivationInterceptor (org.apache.struts2.interceptor)
invoke:247, DefaultActionInvocation (com.opensymphony.xwork2)
invoke:135, RestActionInvocation (org.apache.struts2.rest)
intercept:253, DebuggingInterceptor (org.apache.struts2.interceptor.debugging)
invoke:247, DefaultActionInvocation (com.opensymphony.xwork2)
invoke:135, RestActionInvocation (org.apache.struts2.rest)
intercept:157, ChainingInterceptor (com.opensymphony.xwork2.interceptor)
invoke:247, DefaultActionInvocation (com.opensymphony.xwork2)
invoke:135, RestActionInvocation (org.apache.struts2.rest)
intercept:123, I18nInterceptor (org.apache.struts2.interceptor)
invoke:247, DefaultActionInvocation (com.opensymphony.xwork2)
invoke:135, RestActionInvocation (org.apache.struts2.rest)
doIntercept:174, PrepareInterceptor (com.opensymphony.xwork2.interceptor)
intercept:98, MethodFilterInterceptor (com.opensymphony.xwork2.interceptor)
invoke:247, DefaultActionInvocation (com.opensymphony.xwork2)
invoke:135, RestActionInvocation (org.apache.struts2.rest)
intercept:211, MessageStoreInterceptor (org.apache.struts2.interceptor)
invoke:247, DefaultActionInvocation (com.opensymphony.xwork2)
invoke:135, RestActionInvocation (org.apache.struts2.rest)
intercept:171, ServletConfigInterceptor (org.apache.struts2.interceptor)
invoke:247, DefaultActionInvocation (com.opensymphony.xwork2)
invoke:135, RestActionInvocation (org.apache.struts2.rest)
intercept:201, AliasInterceptor (com.opensymphony.xwork2.interceptor)
invoke:247, DefaultActionInvocation (com.opensymphony.xwork2)
invoke:135, RestActionInvocation (org.apache.struts2.rest)
intercept:193, ExceptionMappingInterceptor (com.opensymphony.xwork2.interceptor)
invoke:247, DefaultActionInvocation (com.opensymphony.xwork2)
invoke:135, RestActionInvocation (org.apache.struts2.rest)
execute:160, DefaultActionProxy (com.opensymphony.xwork2)
serviceAction:577, Dispatcher (org.apache.struts2.dispatcher)
executeAction:81, ExecuteOperations (org.apache.struts2.dispatcher)
doFilter:143, StrutsPrepareAndExecuteFilter (org.apache.struts2.dispatcher.filter)
internalDoFilter:181, ApplicationFilterChain (org.apache.catalina.core)
doFilter:156, ApplicationFilterChain (org.apache.catalina.core)
invoke:168, StandardWrapperValve (org.apache.catalina.core)
invoke:90, StandardContextValve (org.apache.catalina.core)
invoke:483, AuthenticatorBase (org.apache.catalina.authenticator)
invoke:130, StandardHostValve (org.apache.catalina.core)
invoke:93, ErrorReportValve (org.apache.catalina.valves)
invoke:679, AbstractAccessLogValve (org.apache.catalina.valves)
invoke:74, StandardEngineValve (org.apache.catalina.core)
service:346, CoyoteAdapter (org.apache.catalina.connector)
service:617, Http11Processor (org.apache.coyote.http11)
process:63, AbstractProcessorLight (org.apache.coyote)
process:934, AbstractProtocol$ConnectionHandler (org.apache.coyote)
doRun:1698, NioEndpoint$SocketProcessor (org.apache.tomcat.util.net)
run:52, SocketProcessorBase (org.apache.tomcat.util.net)
runWorker:1191, ThreadPoolExecutor (org.apache.tomcat.util.threads)
run:659, ThreadPoolExecutor$Worker (org.apache.tomcat.util.threads)
run:63, TaskThread$WrappingRunnable (org.apache.tomcat.util.threads)
run:745, Thread (java.lang)
```

